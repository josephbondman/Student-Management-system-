/*
 * Digital Attendance System
 * Author:     Joseph Bondman
 * Student ID: 01243803D
 * Programme:  HND Electrical Engineering
 * Institution: Accra Technical University
 */

#include <iostream>
#include <vector>
#include <string>
#include <map>
#include <fstream>
#include <sstream>
#include <iomanip>
#include <algorithm>

using namespace std;

// ======================== Student Class ========================
class Student {
public:
    string indexNumber;
    string name;

    Student() {}
    Student(string idx, string n) : indexNumber(idx), name(n) {}

    void display() const {
        cout << "  Index: " << indexNumber << "  |  Name: " << name << endl;
    }
};

// =================== AttendanceSession Class ===================
class AttendanceSession {
public:
    string courseCode;
    string date;
    string startTime;
    int duration; // in minutes
    map<string, string> attendance; // indexNumber -> "Present"/"Absent"/"Late"

    AttendanceSession() : duration(0) {}
    AttendanceSession(string cc, string d, string st, int dur)
        : courseCode(cc), date(d), startTime(st), duration(dur) {}

    void markAttendance(const string& indexNumber, const string& status) {
        attendance[indexNumber] = status;
    }

    string getFilename() const {
        // Format: session_EE201_2026_02_20.txt
        string fname = "session_" + courseCode + "_";
        for (char c : date) {
            fname += (c == '-') ? '_' : c;
        }
        fname += ".txt";
        return fname;
    }

    void displayAttendanceList(const vector<Student>& students) const {
        cout << "\n========================================\n";
        cout << "  Attendance List\n";
        cout << "  Course: " << courseCode << "  |  Date: " << date << "\n";
        cout << "  Time: " << startTime << "  |  Duration: " << duration << " min\n";
        cout << "========================================\n";

        if (attendance.empty()) {
            cout << "  No attendance records yet.\n";
            return;
        }

        cout << left << setw(15) << "  Index" << setw(25) << "Name" << "Status" << endl;
        cout << "  " << string(50, '-') << endl;

        for (const auto& entry : attendance) {
            // Find student name
            string studentName = "Unknown";
            for (const auto& s : students) {
                if (s.indexNumber == entry.first) {
                    studentName = s.name;
                    break;
                }
            }
            cout << "  " << left << setw(13) << entry.first
                 << setw(25) << studentName << entry.second << endl;
        }
    }

    void displaySummary() const {
        int present = 0, absent = 0, late = 0;
        for (const auto& entry : attendance) {
            if (entry.second == "Present") present++;
            else if (entry.second == "Absent") absent++;
            else if (entry.second == "Late") late++;
        }

        cout << "\n========================================\n";
        cout << "  Attendance Summary\n";
        cout << "  Course: " << courseCode << "  |  Date: " << date << "\n";
        cout << "========================================\n";
        cout << "  Present: " << present << endl;
        cout << "  Absent:  " << absent << endl;
        cout << "  Late:    " << late << endl;
        cout << "  Total:   " << (present + absent + late) << endl;
    }
};

// =================== File Handling Functions ===================

void saveStudents(const vector<Student>& students) {
    ofstream file("students.txt");
    if (!file.is_open()) {
        cout << "  Error: Could not open students.txt for writing.\n";
        return;
    }
    for (const auto& s : students) {
        file << s.indexNumber << "," << s.name << "\n";
    }
    file.close();
}

vector<Student> loadStudents() {
    vector<Student> students;
    ifstream file("students.txt");
    if (!file.is_open()) return students;

    string line;
    while (getline(file, line)) {
        size_t comma = line.find(',');
        if (comma != string::npos) {
            string idx = line.substr(0, comma);
            string name = line.substr(comma + 1);
            students.push_back(Student(idx, name));
        }
    }
    file.close();
    return students;
}

void saveSession(const AttendanceSession& session) {
    ofstream file(session.getFilename());
    if (!file.is_open()) {
        cout << "  Error: Could not save session file.\n";
        return;
    }
    // First line: session metadata
    file << session.courseCode << "," << session.date << ","
         << session.startTime << "," << session.duration << "\n";
    // Remaining lines: attendance records
    for (const auto& entry : session.attendance) {
        file << entry.first << "," << entry.second << "\n";
    }
    file.close();
}

AttendanceSession loadSession(const string& filename) {
    AttendanceSession session;
    ifstream file(filename);
    if (!file.is_open()) return session;

    string line;
    // Read metadata line
    if (getline(file, line)) {
        stringstream ss(line);
        string token;
        vector<string> tokens;
        while (getline(ss, token, ',')) {
            tokens.push_back(token);
        }
        if (tokens.size() >= 4) {
            session.courseCode = tokens[0];
            session.date = tokens[1];
            session.startTime = tokens[2];
            session.duration = stoi(tokens[3]);
        }
    }
    // Read attendance records
    while (getline(file, line)) {
        size_t comma = line.find(',');
        if (comma != string::npos) {
            string idx = line.substr(0, comma);
            string status = line.substr(comma + 1);
            session.attendance[idx] = status;
        }
    }
    file.close();
    return session;
}

// ===================== Helper Functions ========================

// Check if a student index already exists
bool indexExists(const vector<Student>& students, const string& idx) {
    for (const auto& s : students) {
        if (s.indexNumber == idx) return true;
    }
    return false;
}

// Search for a student by index number, return position or -1
int findStudentByIndex(const vector<Student>& students, const string& idx) {
    for (int i = 0; i < (int)students.size(); i++) {
        if (students[i].indexNumber == idx) return i;
    }
    return -1;
}

// Validate date format (YYYY-MM-DD)
bool isValidDate(const string& date) {
    if (date.length() != 10) return false;
    if (date[4] != '-' || date[7] != '-') return false;
    for (int i = 0; i < 10; i++) {
        if (i == 4 || i == 7) continue;
        if (!isdigit(date[i])) return false;
    }
    return true;
}

// Validate time format (HH:MM)
bool isValidTime(const string& t) {
    if (t.length() != 5) return false;
    if (t[2] != ':') return false;
    if (!isdigit(t[0]) || !isdigit(t[1]) || !isdigit(t[3]) || !isdigit(t[4]))
        return false;
    int hour = stoi(t.substr(0, 2));
    int minute = stoi(t.substr(3, 2));
    return (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59);
}

// Display a numbered list of sessions
void listSessions(const vector<AttendanceSession>& sessions) {
    for (int i = 0; i < (int)sessions.size(); i++) {
        cout << "  " << (i + 1) << ". " << sessions[i].courseCode
             << " | " << sessions[i].date
             << " | " << sessions[i].startTime
             << " | " << sessions[i].duration << " min" << endl;
    }
}

// ======================== Main Program =========================
int main() {
    vector<Student> students = loadStudents();
    vector<AttendanceSession> sessions;
    int choice;

    cout << "========================================\n";
    cout << "   Digital Attendance System\n";
    cout << "========================================\n";
    cout << "  " << students.size() << " student(s) loaded from file.\n";

    do {
        cout << "\n============= MAIN MENU ================\n";
        cout << "  1. Register Student\n";
        cout << "  2. View All Students\n";
        cout << "  3. Search Student by Index\n";
        cout << "  4. Create Attendance Session\n";
        cout << "  5. Mark Attendance\n";
        cout << "  6. Update Attendance Record\n";
        cout << "  7. View Attendance List for Session\n";
        cout << "  8. View Attendance Summary\n";
        cout << "  9. Save All Data\n";
        cout << "  10. Load Session from File\n";
        cout << "  0. Exit\n";
        cout << "========================================\n";
        cout << "  Enter choice: ";
        cin >> choice;

        // Handle invalid input (non-integer)
        if (cin.fail()) {
            cin.clear();
            cin.ignore(10000, '\n');
            cout << "  Invalid input. Please enter a number.\n";
            continue;
        }
        cin.ignore(10000, '\n');

        switch (choice) {

        // ---- 1. Register Student ----
        case 1: {
            string idx, name;
            cout << "\n--- Register Student ---\n";
            cout << "  Enter index number: ";
            getline(cin, idx);

            if (idx.empty()) {
                cout << "  Error: Index number cannot be empty.\n";
                break;
            }
            if (indexExists(students, idx)) {
                cout << "  Error: A student with index " << idx << " already exists.\n";
                break;
            }

            cout << "  Enter full name: ";
            getline(cin, name);

            if (name.empty()) {
                cout << "  Error: Name cannot be empty.\n";
                break;
            }

            students.push_back(Student(idx, name));
            cout << "  Student registered successfully.\n";
            break;
        }

        // ---- 2. View All Students ----
        case 2: {
            cout << "\n--- All Registered Students ---\n";
            if (students.empty()) {
                cout << "  No students registered yet.\n";
            } else {
                cout << left << setw(15) << "  Index" << "Name" << endl;
                cout << "  " << string(40, '-') << endl;
                for (const auto& s : students) {
                    s.display();
                }
                cout << "  Total: " << students.size() << " student(s)\n";
            }
            break;
        }

        // ---- 3. Search Student by Index ----
        case 3: {
            string idx;
            cout << "\n--- Search Student ---\n";
            cout << "  Enter index number to search: ";
            getline(cin, idx);

            int pos = findStudentByIndex(students, idx);
            if (pos == -1) {
                cout << "  Student with index " << idx << " not found.\n";
            } else {
                cout << "  Student found:\n";
                students[pos].display();
            }
            break;
        }

        // ---- 4. Create Attendance Session ----
        case 4: {
            string courseCode, date, startTime;
            int duration;

            cout << "\n--- Create Attendance Session ---\n";
            cout << "  Enter course code (e.g., EE201): ";
            getline(cin, courseCode);
            if (courseCode.empty()) {
                cout << "  Error: Course code cannot be empty.\n";
                break;
            }

            cout << "  Enter date (YYYY-MM-DD): ";
            getline(cin, date);
            if (!isValidDate(date)) {
                cout << "  Error: Invalid date format. Use YYYY-MM-DD.\n";
                break;
            }

            cout << "  Enter start time (HH:MM): ";
            getline(cin, startTime);
            if (!isValidTime(startTime)) {
                cout << "  Error: Invalid time format. Use HH:MM.\n";
                break;
            }

            cout << "  Enter duration in minutes: ";
            cin >> duration;
            if (cin.fail() || duration <= 0) {
                cin.clear();
                cin.ignore(10000, '\n');
                cout << "  Error: Duration must be a positive number.\n";
                break;
            }
            cin.ignore(10000, '\n');

            sessions.push_back(AttendanceSession(courseCode, date, startTime, duration));
            cout << "  Attendance session created successfully.\n";
            break;
        }

        // ---- 5. Mark Attendance ----
        case 5: {
            cout << "\n--- Mark Attendance ---\n";
            if (sessions.empty()) {
                cout << "  No sessions available. Create a session first.\n";
                break;
            }
            if (students.empty()) {
                cout << "  No students registered. Register students first.\n";
                break;
            }

            cout << "  Available sessions:\n";
            listSessions(sessions);
            cout << "  Select session number: ";
            int sessionNum;
            cin >> sessionNum;
            cin.ignore(10000, '\n');

            if (sessionNum < 1 || sessionNum > (int)sessions.size()) {
                cout << "  Error: Invalid session number.\n";
                break;
            }

            AttendanceSession& session = sessions[sessionNum - 1];

            cout << "\n  Marking attendance for " << session.courseCode
                 << " on " << session.date << "\n";
            cout << "  Enter status for each student: P = Present, A = Absent, L = Late\n\n";

            for (const auto& s : students) {
                string status;
                // Show existing status if already marked
                if (session.attendance.find(s.indexNumber) != session.attendance.end()) {
                    cout << "  " << s.indexNumber << " (" << s.name << ") ["
                         << session.attendance[s.indexNumber] << "]: ";
                } else {
                    cout << "  " << s.indexNumber << " (" << s.name << "): ";
                }
                getline(cin, status);

                // Convert shorthand to full status
                if (status == "P" || status == "p") status = "Present";
                else if (status == "A" || status == "a") status = "Absent";
                else if (status == "L" || status == "l") status = "Late";
                else if (status.empty()) {
                    // Keep existing or default to Absent
                    if (session.attendance.find(s.indexNumber) == session.attendance.end()) {
                        status = "Absent";
                    } else {
                        continue; // keep existing
                    }
                } else {
                    cout << "    Invalid status, defaulting to Absent.\n";
                    status = "Absent";
                }

                session.markAttendance(s.indexNumber, status);
            }
            cout << "  Attendance marked successfully.\n";
            break;
        }

        // ---- 6. Update Attendance Record ----
        case 6: {
            cout << "\n--- Update Attendance Record ---\n";
            if (sessions.empty()) {
                cout << "  No sessions available.\n";
                break;
            }

            cout << "  Available sessions:\n";
            listSessions(sessions);
            cout << "  Select session number: ";
            int sessionNum;
            cin >> sessionNum;
            cin.ignore(10000, '\n');

            if (sessionNum < 1 || sessionNum > (int)sessions.size()) {
                cout << "  Error: Invalid session number.\n";
                break;
            }

            AttendanceSession& session = sessions[sessionNum - 1];

            string idx;
            cout << "  Enter student index number to update: ";
            getline(cin, idx);

            if (!indexExists(students, idx)) {
                cout << "  Error: Student with index " << idx << " not found.\n";
                break;
            }

            if (session.attendance.find(idx) == session.attendance.end()) {
                cout << "  No existing record for this student in this session.\n";
                cout << "  A new record will be created.\n";
            } else {
                cout << "  Current status: " << session.attendance[idx] << endl;
            }

            cout << "  Enter new status (P = Present, A = Absent, L = Late): ";
            string status;
            getline(cin, status);

            if (status == "P" || status == "p") status = "Present";
            else if (status == "A" || status == "a") status = "Absent";
            else if (status == "L" || status == "l") status = "Late";
            else {
                cout << "  Error: Invalid status.\n";
                break;
            }

            session.markAttendance(idx, status);
            cout << "  Attendance updated successfully.\n";
            break;
        }

        // ---- 7. View Attendance List for Session ----
        case 7: {
            cout << "\n--- View Attendance List ---\n";
            if (sessions.empty()) {
                cout << "  No sessions available.\n";
                break;
            }

            cout << "  Available sessions:\n";
            listSessions(sessions);
            cout << "  Select session number: ";
            int sessionNum;
            cin >> sessionNum;
            cin.ignore(10000, '\n');

            if (sessionNum < 1 || sessionNum > (int)sessions.size()) {
                cout << "  Error: Invalid session number.\n";
                break;
            }

            sessions[sessionNum - 1].displayAttendanceList(students);
            break;
        }

        // ---- 8. View Attendance Summary ----
        case 8: {
            cout << "\n--- View Attendance Summary ---\n";
            if (sessions.empty()) {
                cout << "  No sessions available.\n";
                break;
            }

            cout << "  Available sessions:\n";
            listSessions(sessions);
            cout << "  Select session number: ";
            int sessionNum;
            cin >> sessionNum;
            cin.ignore(10000, '\n');

            if (sessionNum < 1 || sessionNum > (int)sessions.size()) {
                cout << "  Error: Invalid session number.\n";
                break;
            }

            sessions[sessionNum - 1].displaySummary();
            break;
        }

        // ---- 9. Save All Data ----
        case 9: {
            cout << "\n--- Saving Data ---\n";
            saveStudents(students);
            cout << "  Students saved to students.txt\n";

            for (const auto& session : sessions) {
                saveSession(session);
                cout << "  Session saved to " << session.getFilename() << endl;
            }

            cout << "  All data saved successfully.\n";
            break;
        }

        // ---- 10. Load Session from File ----
        case 10: {
            cout << "\n--- Load Session from File ---\n";
            cout << "  Enter session filename (e.g., session_EE201_2026_02_20.txt): ";
            string filename;
            getline(cin, filename);

            ifstream check(filename);
            if (!check.is_open()) {
                cout << "  Error: File '" << filename << "' not found.\n";
                break;
            }
            check.close();

            AttendanceSession loaded = loadSession(filename);
            if (loaded.courseCode.empty()) {
                cout << "  Error: Could not parse session file.\n";
            } else {
                sessions.push_back(loaded);
                cout << "  Session loaded: " << loaded.courseCode
                     << " | " << loaded.date << " | "
                     << loaded.startTime << " | "
                     << loaded.duration << " min\n";
                cout << "  " << loaded.attendance.size() << " attendance record(s) loaded.\n";
            }
            break;
        }

        // ---- 0. Exit ----
        case 0: {
            // Auto-save before exiting
            saveStudents(students);
            for (const auto& session : sessions) {
                saveSession(session);
            }
            cout << "  Data saved. Goodbye!\n";
            break;
        }

        default:
            cout << "  Invalid choice. Please try again.\n";
        }

    } while (choice != 0);

    return 0;
}
